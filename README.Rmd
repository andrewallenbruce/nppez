---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = TRUE,
  echo      = TRUE,
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 300, 
  out.width = "100%",
  fig.path  = "man/figures/README-"
)
```

# {nppez}

<!-- badges: start -->
<!-- badges: end -->

## Installation

You can install the development version of {nppez} from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("andrewallenbruce/nppez")
```

```{r}
library(nppez)
```

# Browse

```{r browse, results='asis', eval=FALSE}
nppez::browse()
```

|date       |file                                                 |    size|zip_url                                                                          |
|:----------|:----------------------------------------------------|-------:|:--------------------------------------------------------------------------------|
|2023-04-10 |NPPES Data Dissemination                             | 851.05M|https://download.cms.gov/nppes/NPPES_Data_Dissemination_April_2023.zip           |
|2023-04-10 |NPPES Data Dissemination Monthly Deactivation Update |   1.78M|https://download.cms.gov/nppes/NPPES_Deactivated_NPI_Report_041023.zip           |
|2023-04-03 |NPPES Data Dissemination Weekly Update               |   3.62M|https://download.cms.gov/nppes/NPPES_Data_Dissemination_040323_040923_Weekly.zip |

# Grab

```{r grab, eval=FALSE}
nppez::grab(dir = "D:/nppez_data/zips/")
```

```{r results='asis', echo=FALSE, eval=FALSE}
fs::dir_info("D:/nppez_data/zips/") |> 
  dplyr::select(date = birth_time, size, filename = path) |> 
  dplyr::mutate(date = clock::as_date(date)) |> 
  gluedown::md_table()
```


|date       |    size|filename                                                             |
|:----------|-------:|:--------------------------------------------------------------------|
|2023-04-12 |   3.62M|D:/nppez_data/zips/NPPES_Data_Dissemination_040323_040923_Weekly.zip |
|2023-04-12 | 851.05M|D:/nppez_data/zips/NPPES_Data_Dissemination_April_2023.zip           |
|2023-04-12 |   1.78M|D:/nppez_data/zips/NPPES_Deactivated_NPI_Report_041023.zip           |

# Peek

```{r, results='asis'}
peek <- nppez::peek(dir = "D:/nppez_data/zips/")
```


```{r, results='asis'}
peek |> 
  dplyr::group_by(parent_zip) |> 
  dplyr::mutate(csv = stringr::str_extract_all(filename, "[.]csv$")) |> 
  tidyr::unnest(csv) |>
  dplyr::mutate(fileheader = stringr::str_ends(filename, "fileheader[.]csv$", negate = TRUE)) |> 
  dplyr::filter(fileheader == TRUE) |>
  dplyr::mutate(csv = NULL, fileheader = NULL) |> 
  dplyr::summarise(size_compressed = sum(size_compressed),
                   size_uncompressed = sum(size_uncompressed)) |> 
  gluedown::md_table()
```


```{r, results='asis'}
peek |> 
  dplyr::filter(parent_zip == "NPPES_Data_Dissemination_040323_040923_Weekly.zip") |> 
  dplyr::mutate(csv = stringr::str_extract_all(filename, "[.]csv$")) |> 
  tidyr::unnest(csv) |>
  dplyr::mutate(fileheader = stringr::str_ends(filename, "fileheader[.]csv$", negate = TRUE)) |> 
  dplyr::filter(fileheader == TRUE) |>
  dplyr::mutate(csv = NULL, fileheader = NULL) |> 
  gluedown::md_table()
```


```{r, results='asis'}
peek |> 
dplyr::filter(parent_zip == "NPPES_Data_Dissemination_April_2023.zip") |> 
  dplyr::mutate(csv = stringr::str_extract_all(filename, "[.]csv$")) |> 
  tidyr::unnest(csv) |>
  dplyr::mutate(fileheader = stringr::str_ends(filename, "fileheader[.]csv$", negate = TRUE)) |> 
  dplyr::filter(fileheader == TRUE) |>
  dplyr::mutate(csv = NULL, fileheader = NULL) |> 
  gluedown::md_table()
```

# Dispense

```{r, eval=FALSE, echo=FALSE}
peek |> 
dplyr::filter(parent_zip == "NPPES_Data_Dissemination_April_2023.zip") |> 
  dplyr::mutate(csv = stringr::str_extract_all(filename, "[.]csv$")) |> 
  tidyr::unnest(csv) |>
  dplyr::mutate(fileheader = stringr::str_ends(filename, "fileheader[.]csv$", negate = TRUE)) |> 
  dplyr::filter(fileheader == TRUE) |>
  dplyr::mutate(csv = NULL, fileheader = NULL)
"NPPES_Data_Dissemination_040323_040923_Weekly.zip"
"NPPES_Data_Dissemination_April_2023.zip"
cvec_files <- zip::zip_list("D:/nppez_data/zips/NPPES_Data_Dissemination_040323_040923_Weekly.zip") |> 
  dplyr::select(filename) |> 
  dplyr::mutate(fileheader = stringr::str_ends(filename, "fileheader[.]csv$", negate = FALSE)) |> 
  dplyr::mutate(pdf = stringr::str_ends(filename, "[.]pdf$", negate = TRUE)) |> 
  dplyr::filter(fileheader == TRUE, pdf == TRUE) |> 
  dplyr::mutate(fileheader = NULL, pdf = NULL) |> 
  tibble::deframe()

cvec_files[-4] |> stringr::str_flatten_comma()
```


```{r dispense, eval=FALSE}
nppez::dispense(zip_dir = "D:/nppez_data/zips/",
                unzip_dir =  "D:/nppez_data/unzips/")
```


```{r, eval=FALSE, echo=FALSE}
zip::unzip("D:/nppez_data/zips/NPPES_Data_Dissemination_040323_040923_Weekly.zip", files = "npidata_pfile_20230403-20230409_fileheader.csv", exdir = "D:/nppez_data/test01/")

up <- zip::unzip_process()$new(zipfile = "D:/nppez_data/zips/NPPES_Data_Dissemination_April_2023.zip", 
          exdir = "D:/nppez_data/test01/")

up$
```

```{r results='asis', echo=FALSE, eval=FALSE}
fs::dir_info("D:/nppez_data/unzips/") |> 
  dplyr::select(date = birth_time, size, filename = path) |> 
  dplyr::mutate(date = clock::as_date(date)) |> 
  dplyr::mutate(csv = stringr::str_extract_all(filename, "[.]csv$")) |> 
  tidyr::unnest(csv) |>
  dplyr::mutate(fileheader = stringr::str_ends(filename, "fileheader[.]csv$", negate = TRUE)) |> 
  dplyr::filter(fileheader == TRUE) |>
  dplyr::mutate(csv = NULL, fileheader = NULL) |> 
  gluedown::md_table()
```

|date       |file                                                                  |    size|
|:----------|:---------------------------------------------------------------------|-------:|
|2023-04-11 |D:/nppez_data/unzips/endpoint_pfile_20050523-20230409.csv             |  96.76M|
|2023-04-11 |D:/nppez_data/unzips/endpoint_pfile_20050523-20230409_fileheader.csv  |     431|
|2023-04-12 |D:/nppez_data/unzips/endpoint_pfile_20230403-20230409.csv             | 330.03K|
|2023-04-12 |D:/nppez_data/unzips/endpoint_pfile_20230403-20230409_fileheader.csv  |     431|
|2023-04-11 |D:/nppez_data/unzips/npidata_pfile_20050523-20230409.csv              |   8.66G|
|2023-04-11 |D:/nppez_data/unzips/npidata_pfile_20050523-20230409_fileheader.csv   |  11.98K|
|2023-04-12 |D:/nppez_data/unzips/npidata_pfile_20230403-20230409.csv              |  28.33M|
|2023-04-12 |D:/nppez_data/unzips/npidata_pfile_20230403-20230409_fileheader.csv   |  11.98K|
|2023-04-11 |D:/nppez_data/unzips/NPPES Deactivated NPI Report 20230410.xlsx       |   3.68M|
|2023-04-11 |D:/nppez_data/unzips/NPPES_Data_Dissemination_CodeValues.pdf          | 543.72K|
|2023-04-11 |D:/nppez_data/unzips/NPPES_Data_Dissemination_Readme.pdf              | 556.21K|
|2023-04-11 |D:/nppez_data/unzips/othername_pfile_20050523-20230409.csv            |  25.88M|
|2023-04-11 |D:/nppez_data/unzips/othername_pfile_20050523-20230409_fileheader.csv |      86|
|2023-04-12 |D:/nppez_data/unzips/othername_pfile_20230403-20230409.csv            |  86.44K|
|2023-04-12 |D:/nppez_data/unzips/othername_pfile_20230403-20230409_fileheader.csv |      86|
|2023-04-11 |D:/nppez_data/unzips/pl_pfile_20050523-20230409.csv                   |  65.51M|
|2023-04-11 |D:/nppez_data/unzips/pl_pfile_20050523-20230409_fileheader.csv        |     578|
|2023-04-12 |D:/nppez_data/unzips/pl_pfile_20230403-20230409.csv                   | 431.35K|
|2023-04-12 |D:/nppez_data/unzips/pl_pfile_20230403-20230409_fileheader.csv        |     578|
|2023-04-11 |D:/nppez_data/unzips/weekly                                           |       0|


# Clean

## Weekly Update

  Each week, a file will be available for download. This file will contain only the new FOIA-disclosable NPPES provider data since the last weekly or monthly file was generated.

```{r}
weekly <- clean_weekly_update()
weekly <- datawizard::data_peek(weekly)
weekly
```


## Monthly Deactivations

The FOIA-disclosable data for a health care provider (individual or organization) who deactivated an NPI will now be disclosed within the files.  For a deactivated NPI, CMS will only disclose the deactivated NPI and the associated date of deactivation within the files.

```{r}
deactivation <- clean_deactivation(dir_xlsx = "D:/nppez_data/unzips")
deactivation <- datawizard::data_peek(deactivation)
deactivation
```

## Monthly Endpoints

  − File contains all Endpoints associated with Type 1 and Type 2 NPIs

```{r}
endpoints <- readr::read_csv(
  "D:/nppez_data/unzips/endpoint_pfile_20050523-20230409.csv", 
  col_types = "ccc",
  name_repair = janitor::make_clean_names) |> 
  dplyr::arrange(npi)
endpoints <- datawizard::data_peek(endpoints)
endpoints
```

## Monthly Other Names

  − File contains additional Other Names associated with Type 2 NPIs

```{r}
othernames <- readr::read_csv(
  "D:/nppez_data/unzips/othername_pfile_20050523-20230409.csv", 
  col_types = "ccc",
  name_repair = janitor::make_clean_names) |> 
  dplyr::rename(other_organization_name = provider_other_organization_name,
                other_organization_type = provider_other_organization_name_type_code)
othernames <- datawizard::data_peek(othernames)
othernames
```

## Monthly Practice Locations

   − File contains all of the non-primary Practice Locations associated with Type 1 and Type 2 NPIs.

```{r}
locations <- readr::read_csv(
  "D:/nppez_data/unzips/pl_pfile_20050523-20230409.csv", 
  #col_types = "ccc",
  name_repair = janitor::make_clean_names) |> 
  janitor::remove_empty()
locations <- datawizard::data_peek(locations)
locations
```

## Monthly Update
